# 05-vault/vault-init-job.yaml
# One-time job to initialize Vault, unseal it, and enable KV v2 engine
# 
# Usage:
#   1. Wait for Vault pod to be running: kubectl get pods -l app=vault -n netpulse
#   2. Apply this job: kubectl apply -f k8s/05-vault-init-job.yaml
#   3. Get the token: kubectl logs job/vault-init -n netpulse
#
# Note: For production, consider using Vault Auto-unseal or manual unseal process
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: netpulse
spec:
  template:
    spec:
      serviceAccountName: vault-init
      containers:
      - name: vault-init
        image: hashicorp/vault:1.15
        command:
        - sh
        - -c
        - |
          set -e
          export VAULT_ADDR="http://vault:8200"

          echo "Waiting for Vault service to respond..."
          until vault status > /dev/null 2>&1 || [ $? -ne 127 ]; do
            echo "Still waiting for Vault..."
            sleep 2
          done

          # 1. Initialize if needed
          if ! vault status | grep -q "Initialized.*true"; then
            echo "Initializing Vault..."
            vault operator init -key-shares=1 -key-threshold=1 -format=json > /tmp/vault-init.json
            
            UNSEAL_KEY=$(cat /tmp/vault-init.json | jq -r '.unseal_keys_b64[0]')
            ROOT_TOKEN=$(cat /tmp/vault-init.json | jq -r '.root_token')
            
            echo "IMPORTANT: INITIALIZATION SUCCESSFUL"
            echo "Unseal Key: $UNSEAL_KEY"
            echo "Root Token: $ROOT_TOKEN"
            
            # Save to temporary location (Pod will exit, but logs will remain)
            echo "$UNSEAL_KEY" > /tmp/unseal.key
            echo "$ROOT_TOKEN" > /tmp/root.token
          else
            echo "Vault already initialized."
          fi

          # 2. Unseal if needed
          if vault status | grep -q "Sealed.*true"; then
            echo "Vault is sealed. Attempting to unseal..."
            if [ -f /tmp/unseal.key ]; then
              vault operator unseal $(cat /tmp/unseal.key)
            else
              echo "Error: Vault is sealed but unseal key is missing in this job run."
              echo "Manual unseal required or re-run initialization."
              exit 1
            fi
          fi

          # 3. Enable KV v2 Engine
          echo "Ensuring KV v2 engine is enabled at kv/..."
          # If we just initialized, we have the token in /tmp/root.token
          if [ -f /tmp/root.token ]; then
             export VAULT_TOKEN=$(cat /tmp/root.token)
             if ! vault secrets list | grep -q "^kv/"; then
               echo "Enabling KV v2..."
               vault secrets enable -path=kv kv-v2
             fi
             echo "Vault setup complete and ready for Netpulse."
          else
             echo "Job finished. If this was a re-run, check manual status."
          fi
        env:
        - name: VAULT_ADDR
          value: "http://vault:8200"
      restartPolicy: OnFailure
---
# ServiceAccount and RBAC for vault-init job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-init
  namespace: netpulse
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-init
  namespace: netpulse
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-init
  namespace: netpulse
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-init
subjects:
- kind: ServiceAccount
  name: vault-init
  namespace: netpulse
