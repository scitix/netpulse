# 02-netpulse/configmap.yaml
# ConfigMap for Netpulse non-secret environment variables
# This ConfigMap contains all non-sensitive configuration options shared by controller and worker
apiVersion: v1
kind: ConfigMap
metadata:
  name: netpulse-config
  namespace: netpulse
  labels:
    app: netpulse
    component: shared
# Update these values as needed for your deployment
# Secrets (passwords, API keys) are NOT included here
data:
  NETPULSE_LOG__LEVEL: "INFO"
  NETPULSE_WORKER__PINNED_PER_NODE: "128" # Max number of connected devices per pod
  NETPULSE_REDIS__HOST: "netpulse-redis-master"    # Operator 创建: 始终指向主节点
  NETPULSE_REDIS__PORT: "6379"
  NETPULSE_REDIS__TLS__ENABLED: "false"
  # Vault Credential Provider Configuration
  NETPULSE_CREDENTIAL__ENABLED: "true"
  NETPULSE_CREDENTIAL__NAME: "vault_kv"
  NETPULSE_CREDENTIAL__ADDR: "http://vault:8200"
  NETPULSE_CREDENTIAL__ALLOWED_PATHS: "kv/netpulse"
  NETPULSE_CREDENTIAL__VERIFY: "false"
  NETPULSE_CREDENTIAL__CACHE_TTL: "60" # Optimized cache for production
---
# 02-netpulse/controller.deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netpulse-controller
  namespace: netpulse
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netpulse
      component: controller
  template:
    metadata:
      labels:
        app: netpulse
        component: controller
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: netpulse
                  component: controller
              topologyKey: kubernetes.io/hostname
      containers:
      - name: controller
        image: localhost/netpulse-controller:latest
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            memory: "1Gi"
            cpu: "400m"   
          limits:
            memory: "2Gi"
        envFrom:
        - configMapRef:
            name: netpulse-config
        env:
        - name: NETPULSE_SERVER__API_KEY
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: api-key
        - name: NETPULSE_REDIS__PASSWORD
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: password
        - name: NETPULSE_REDIS__SENTINEL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: password
        - name: NETPULSE_VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: vault-token
        ports:
        - containerPort: 9000
---
# 02-netpulse/node-worker.deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netpulse-node-worker
  namespace: netpulse
spec:
  replicas: 18
  selector:
    matchLabels:
      app: netpulse
      component: node-worker
  template:
    metadata:
      labels:
        app: netpulse
        component: node-worker
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: netpulse
                  component: node-worker
              topologyKey: kubernetes.io/hostname
      containers:
      - name: node-worker
        image: localhost/netpulse-node-worker:latest
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            memory: "2Gi"    
            cpu: "300m"      
          limits:
            memory: "8Gi"    
        envFrom:
        - configMapRef:
            name: netpulse-config
        env:
        - name: NETPULSE_SERVER__API_KEY
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: api-key
        - name: NETPULSE_REDIS__PASSWORD
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: password
        - name: NETPULSE_REDIS__SENTINEL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: password
        - name: NETPULSE_VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: vault-token
---
# 02-netpulse/fifo-worker.deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netpulse-fifo-worker
  namespace: netpulse
spec:
  replicas: 12
  selector:
    matchLabels:
      app: netpulse
      component: fifo-worker
  template:
    metadata:
      labels:
        app: netpulse
        component: fifo-worker
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: netpulse
                  component: fifo-worker
              topologyKey: kubernetes.io/hostname
      containers:
      - name: fifo-worker
        image: localhost/netpulse-fifo-worker:latest
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            memory: "1Gi"  
            cpu: "300m"     
          limits:
            memory: "2Gi"    
        envFrom:
        - configMapRef:
            name: netpulse-config
        env:
        - name: NETPULSE_SERVER__API_KEY
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: api-key
        - name: NETPULSE_REDIS__PASSWORD
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: password
        - name: NETPULSE_REDIS__SENTINEL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: password
        - name: NETPULSE_VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: netpulse-secrets
              key: vault-token
---
# 02-netpulse/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: netpulse
  namespace: netpulse
spec:
  selector:
    app: netpulse
    component: controller
  ports:
  - port: 9000
    targetPort: 9000
  type: ClusterIP # Could be LoadBalancer if not using Ingress.
