# ä»»åŠ¡è°ƒåº¦å™¨

NetPulse æä¾›äº†å¤šç§è°ƒåº¦å™¨æ’ä»¶ï¼Œç”¨äºä¸º Pinned Worker é€‰æ‹©è¿è¡ŒèŠ‚ç‚¹ï¼ˆNodeï¼‰ã€‚è°ƒåº¦å™¨åœ¨ä»»åŠ¡éœ€è¦åˆ›å»ºæ–°çš„ Pinned Worker æ—¶è¢«è°ƒç”¨ï¼Œæ ¹æ®èŠ‚ç‚¹çš„è´Ÿè½½å’Œå®¹é‡é€‰æ‹©æœ€åˆé€‚çš„èŠ‚ç‚¹æ¥è¿è¡Œ Pinned Workerã€‚

!!! note "è°ƒåº¦å™¨çš„ä½œç”¨"
    è°ƒåº¦å™¨ä¸æ˜¯ç›´æ¥åˆ†é…ä»»åŠ¡ç»™ Pinned Workerï¼Œè€Œæ˜¯ä¸º Pinned Worker é€‰æ‹©è¿è¡ŒèŠ‚ç‚¹ã€‚ä»»åŠ¡é€šè¿‡ Redis é˜Ÿåˆ—åˆ†é…ç»™å¯¹åº”çš„ Pinned Workerã€‚

## è°ƒåº¦ç®—æ³•æ¦‚è¿°

NetPulse ç›®å‰æ”¯æŒå››ç§è°ƒåº¦ç®—æ³•ï¼Œæ¯ç§ç®—æ³•é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚**é»˜è®¤ç®—æ³•ä¸º `load_weighted_random`**ï¼Œé€‚åˆå¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒã€‚

### ç®—æ³•å¯¹æ¯”è¡¨

| ç®—æ³• | ç¡®å®šæ€§ | è´Ÿè½½å‡è¡¡ | è°ƒåº¦å†²çª | èŠ‚ç‚¹åˆ©ç”¨ç‡ | å…¬å¹³æ€§ | å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|------|--------|----------|----------|------------|--------|--------|----------|
| **è´ªå©ªè°ƒåº¦å™¨** (greedy) | âœ… æ˜¯ | â­â­ | é«˜ | æé«˜ | ä½ | O(N) | å•èŠ‚ç‚¹éƒ¨ç½² |
| **æœ€å°è´Ÿè½½è°ƒåº¦å™¨** (least_load) | âœ… æ˜¯ | â­â­â­â­â­ | ä¸­ | é«˜ | é«˜ | O(N log N) | å¤šèŠ‚ç‚¹å‡è¡¡ |
| **æœ€å°è´Ÿè½½éšæœºè°ƒåº¦å™¨** (least_load_random) | âŒ å¦ | â­â­â­â­ | ä½ | é«˜ | ä¸­ | O(N log N) | é«˜å¹¶å‘åœºæ™¯ |
| **è´Ÿè½½åŠ æƒéšæœºè°ƒåº¦å™¨** (load_weighted_random) â­é»˜è®¤ | âŒ å¦ | â­â­â­â­ | æä½ | é«˜ | ä¸­é«˜ | O(M*N) | å¤§è§„æ¨¡å¹¶å‘ |

### å¿«é€Ÿé€‰æ‹©æŒ‡å—

- **å•èŠ‚ç‚¹æˆ–å°è§„æ¨¡éƒ¨ç½²ï¼ˆ1-2ä¸ªèŠ‚ç‚¹ï¼‰** â†’ `greedy`
- **å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œéœ€è¦è´Ÿè½½å‡è¡¡ï¼ˆ3-5ä¸ªèŠ‚ç‚¹ï¼‰** â†’ `least_load`
- **é«˜å¹¶å‘åœºæ™¯ï¼ˆçŸ­æ—¶é—´å†…å¤§é‡ä»»åŠ¡ï¼‰** â†’ `least_load_random`
- **å¤§è§„æ¨¡é«˜å¹¶å‘åœºæ™¯ï¼ˆ5+èŠ‚ç‚¹ï¼Œæé«˜å¹¶å‘ï¼‰** â†’ `load_weighted_random` â­é»˜è®¤

## è°ƒåº¦ç®—æ³•è¯¦è§£

### 1. è´ªå©ªè°ƒåº¦å™¨ (Greedy Scheduler)

**ç®—æ³•åç§°**ï¼š`greedy`

**æ ¸å¿ƒæ€æƒ³**ï¼šé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„èŠ‚ç‚¹ï¼Œå°½å¯èƒ½å æ»¡èŠ‚ç‚¹å®¹é‡ã€‚

```mermaid
graph TD
    A[éœ€è¦åˆ›å»ºPinned Worker] --> B[éå†æ‰€æœ‰èŠ‚ç‚¹]
    B --> C{æ‰¾åˆ°ç¬¬ä¸€ä¸ª<br/>count < capacity?}
    C -->|æ˜¯| D[é€‰æ‹©è¯¥èŠ‚ç‚¹]
    C -->|å¦| E[ç»§ç»­éå†]
    E --> F{è¿˜æœ‰èŠ‚ç‚¹?}
    F -->|æ˜¯| C
    F -->|å¦| G[æŠ›å‡ºå®¹é‡é”™è¯¯]
    D --> H[åœ¨è¯¥èŠ‚ç‚¹åˆ›å»ºPinned Worker]
```

**ç®—æ³•å®ç°**ï¼š
```python
def node_select(self, nodes: List[NodeInfo], host: str) -> NodeInfo:
    for n in nodes:
        if n.count < n.capacity:
            return n  # è¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹
    raise WorkerUnavailableError("Insufficient capacity")
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ç¡®å®šæ€§**ï¼šç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡º
- âš¡ **é«˜æ•ˆ**ï¼šç®—æ³•ç®€å•ï¼Œæ—¶é—´å¤æ‚åº¦ O(N)
- ğŸ“Š **è´Ÿè½½åˆ†å¸ƒ**ï¼šä¸ä¿è¯è´Ÿè½½å‡è¡¡ï¼Œå¯èƒ½é€ æˆèŠ‚ç‚¹è´Ÿè½½ä¸å‡
- âš ï¸ **è°ƒåº¦å†²çª**ï¼šé«˜å¹¶å‘æ—¶å¤šä¸ªè¯·æ±‚å¯èƒ½é€‰æ‹©åŒä¸€èŠ‚ç‚¹

**é€‚ç”¨åœºæ™¯**ï¼š
- å•èŠ‚ç‚¹æˆ–å°è§„æ¨¡éƒ¨ç½²ï¼ˆ1-2ä¸ªèŠ‚ç‚¹ï¼‰
- å¯¹è´Ÿè½½å‡è¡¡è¦æ±‚ä¸é«˜çš„åœºæ™¯
- éœ€è¦ç®€å•ã€å¯é¢„æµ‹çš„è°ƒåº¦è¡Œä¸º

**æ‰¹é‡è°ƒåº¦**ï¼š
æ‰¹é‡è°ƒåº¦æ—¶ï¼Œè´ªå©ªç®—æ³•ä¼šå°½å¯èƒ½ç”¨æœ€å°‘çš„èŠ‚ç‚¹æ¥åˆ†é…æ‰€æœ‰ä»»åŠ¡ï¼Œä¼˜å…ˆå¡«æ»¡å·²æœ‰èŠ‚ç‚¹ã€‚

### 2. æœ€å°è´Ÿè½½è°ƒåº¦å™¨ (Least Load Scheduler)

**ç®—æ³•åç§°**ï¼š`least_load`

**æ ¸å¿ƒæ€æƒ³**ï¼šé€‰æ‹©è´Ÿè½½æœ€å°ã€å‰©ä½™å®¹é‡æœ€å¤§çš„èŠ‚ç‚¹ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

```mermaid
graph TD
    A[éœ€è¦åˆ›å»ºPinned Worker] --> B[è¿‡æ»¤å¯ç”¨èŠ‚ç‚¹<br/>count < capacity]
    B --> C[ç¬¬ä¸€é˜¶æ®µï¼šé€‰æ‹©æœ€å°è´Ÿè½½<br/>min count]
    C --> D[ç¬¬äºŒé˜¶æ®µï¼šé€‰æ‹©æœ€å¤§å‰©ä½™å®¹é‡<br/>max capacity - count]
    D --> E[ç¬¬ä¸‰é˜¶æ®µï¼šå­—å…¸åºä¸»æœºå<br/>min hostname]
    E --> F{èŠ‚ç‚¹é€‰æ‹©<br>æˆåŠŸï¼Ÿ}
    F -->|æ˜¯| G[åœ¨è¯¥èŠ‚ç‚¹åˆ›å»ºPinned Worker]
    F -->|å¦| H[æŠ›å‡ºå®¹é‡é”™è¯¯]
```

**ç®—æ³•å®ç°**ï¼š
```python
def node_select(self, nodes: List[NodeInfo], host: str) -> NodeInfo:
    available_nodes = [n for n in nodes if n.count < n.capacity]
    if not available_nodes:
        raise WorkerUnavailableError("Insufficient capacity in node selection")
    
    # ä¸‰é˜¶æ®µé€‰æ‹©ï¼š
    # 1. æœ€å°è´Ÿè½½ (count)
    # 2. æœ€å¤§å‰©ä½™å®¹é‡ (capacity - count)
    # 3. å­—å…¸åºä¸»æœºå (hostname)
    selected_node = None
    for node in available_nodes:
        if not selected_node:
            selected_node = node
            continue
        
        # 1. é€‰æ‹©æœ€å°è´Ÿè½½
        if node.count < selected_node.count:
            selected_node = node
        elif node.count == selected_node.count:
            # 2. é€‰æ‹©æœ€å¤§å‰©ä½™å®¹é‡
            node_remaining = node.capacity - node.count
            selected_remaining = selected_node.capacity - selected_node.count
            if node_remaining > selected_remaining:
                selected_node = node
            elif node_remaining == selected_remaining:
                # 3. é€‰æ‹©å­—å…¸åºæœ€å°çš„ä¸»æœºå
                if node.hostname < selected_node.hostname:
                    selected_node = node
    
    return selected_node
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ç¡®å®šæ€§**ï¼šç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡ºï¼ˆé€šè¿‡å­—å…¸åºä¿è¯ï¼‰
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šä¼˜å…ˆé€‰æ‹©è´Ÿè½½æœ€å°çš„èŠ‚ç‚¹ï¼Œä¿è¯å„èŠ‚ç‚¹è´Ÿè½½ç›¸è¿‘
- ğŸ“Š **å…¬å¹³æ€§**ï¼šè€ƒè™‘å‰©ä½™å®¹é‡ï¼Œé¿å…èŠ‚ç‚¹è¿‡è½½
- âš ï¸ **è°ƒåº¦å†²çª**ï¼šé«˜å¹¶å‘æ—¶ä»å¯èƒ½å‘ç”Ÿå†²çªï¼ˆè™½ç„¶æ¯”è´ªå©ªç®—æ³•å¥½ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆ3+ ä¸ªèŠ‚ç‚¹ï¼‰
- éœ€è¦è´Ÿè½½å‡è¡¡çš„åœºæ™¯
- å¯¹è°ƒåº¦ç»“æœæœ‰ç¡®å®šæ€§è¦æ±‚çš„åœºæ™¯

**æ‰¹é‡è°ƒåº¦**ï¼š
æ‰¹é‡è°ƒåº¦æ—¶ï¼Œç®—æ³•ä¼šæŒ‰è´Ÿè½½çº§åˆ«åˆ†ç»„ï¼Œä¼˜å…ˆå¡«æ»¡è´Ÿè½½æœ€ä½çš„èŠ‚ç‚¹ï¼Œç„¶åä¾æ¬¡å¡«å……æ›´é«˜è´Ÿè½½çš„èŠ‚ç‚¹ï¼Œç¡®ä¿æ•´ä½“è´Ÿè½½åˆ†å¸ƒå‡åŒ€ã€‚

### 3. æœ€å°è´Ÿè½½éšæœºè°ƒåº¦å™¨ (Least Load Random Scheduler)

**ç®—æ³•åç§°**ï¼š`least_load_random`

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨è´Ÿè½½æœ€å°ã€å‰©ä½™å®¹é‡æœ€å¤§çš„å€™é€‰èŠ‚ç‚¹ä¸­éšæœºé€‰æ‹©ï¼Œå…¼é¡¾è´Ÿè½½å‡è¡¡å’Œé™ä½å†²çªã€‚

```mermaid
graph TD
    A[éœ€è¦åˆ›å»ºPinned Worker] --> B[è¿‡æ»¤å¯ç”¨èŠ‚ç‚¹<br/>count < capacity]
    B --> C[ç¬¬ä¸€é˜¶æ®µï¼šæŸ¥æ‰¾æœ€å°è´Ÿè½½<br/>min count]
    C --> D[ç¬¬äºŒé˜¶æ®µï¼šè¿‡æ»¤æœ€å¤§å‰©ä½™å®¹é‡<br/>max capacity - count]
    D --> E[ç¬¬ä¸‰é˜¶æ®µï¼šä»æœ€ä½³å€™é€‰èŠ‚ç‚¹<br/>éšæœºé€‰æ‹©]
    E --> F{èŠ‚ç‚¹é€‰æ‹©<br>æˆåŠŸï¼Ÿ}
    F -->|æ˜¯| G[åœ¨è¯¥èŠ‚ç‚¹åˆ›å»ºPinned Worker]
    F -->|å¦| H[æŠ›å‡ºå®¹é‡é”™è¯¯]
```

**ç®—æ³•å®ç°**ï¼š
```python
def node_select(self, nodes: List[NodeInfo], host: str) -> NodeInfo:
    available_nodes = [n for n in nodes if n.count < n.capacity]
    
    # 1. æ‰¾åˆ°æœ€å°è´Ÿè½½
    min_count = min(n.count for n in available_nodes)
    phase1_candidates = [n for n in available_nodes if n.count == min_count]
    
    # 2. æ‰¾åˆ°æœ€å¤§å‰©ä½™å®¹é‡
    max_remaining = max(n.capacity - n.count for n in phase1_candidates)
    phase2_candidates = [n for n in phase1_candidates 
                        if (n.capacity - n.count) == max_remaining]
    
    # 3. éšæœºé€‰æ‹©
    return random.choice(phase2_candidates)
```

**ç‰¹ç‚¹**ï¼š
- âŒ **éç¡®å®šæ€§**ï¼šç›¸åŒè¾“å…¥å¯èƒ½äº§ç”Ÿä¸åŒè¾“å‡ºï¼ˆéšæœºæ€§ï¼‰
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šä¼˜å…ˆé€‰æ‹©è´Ÿè½½æœ€å°çš„èŠ‚ç‚¹
- ğŸ² **é™ä½å†²çª**ï¼šéšæœºåŒ–é™ä½äº†å¤šä¸ªè¯·æ±‚åŒæ—¶é€‰æ‹©åŒä¸€èŠ‚ç‚¹çš„æ¦‚ç‡
- ğŸ“Š **å…¬å¹³æ€§**ï¼šåœ¨æœ€ä½³å€™é€‰èŠ‚ç‚¹ä¸­éšæœºåˆ†é…

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆ3+ ä¸ªèŠ‚ç‚¹ï¼‰
- é«˜å¹¶å‘åœºæ™¯ï¼ˆçŸ­æ—¶é—´å†…å¤§é‡ä»»åŠ¡ï¼‰
- éœ€è¦è´Ÿè½½å‡è¡¡ä½†å¯ä»¥æ¥å—éç¡®å®šæ€§ç»“æœ

**æ‰¹é‡è°ƒåº¦**ï¼š
æ‰¹é‡è°ƒåº¦æ—¶ï¼Œç®—æ³•ä¼šæŒ‰è´Ÿè½½çº§åˆ«åˆ†ç»„ï¼Œåœ¨æ¯ä¸ªè´Ÿè½½çº§åˆ«å†…ï¼Œä»å…·æœ‰æœ€å¤§å‰©ä½™å®¹é‡çš„èŠ‚ç‚¹ä¸­éšæœºåˆ†é…ä»»åŠ¡ï¼Œç¡®ä¿è´Ÿè½½å‡è¡¡çš„åŒæ—¶é™ä½å†²çªã€‚

### 4. è´Ÿè½½åŠ æƒéšæœºè°ƒåº¦å™¨ (Load Weighted Random Scheduler)

**ç®—æ³•åç§°**ï¼š`load_weighted_random`

**æ ¸å¿ƒæ€æƒ³**ï¼šæ ¹æ®èŠ‚ç‚¹å‰©ä½™å®¹é‡è®¡ç®—æƒé‡ï¼ŒåŠ å…¥éšæœºæ‰°åŠ¨ï¼Œä½¿ç”¨åŠ æƒéšæœºé€‰æ‹©èŠ‚ç‚¹ï¼Œæœ€å¤§åŒ–é™ä½è°ƒåº¦å†²çªã€‚

```mermaid
graph TD
    A[éœ€è¦åˆ›å»ºPinned Worker] --> B[è¿‡æ»¤å¯ç”¨èŠ‚ç‚¹<br/>count < capacity]
    B --> C[è®¡ç®—åŸºç¡€æƒé‡<br/>weight = capacity - count]
    C --> D[æ·»åŠ å“ˆå¸Œæ‰°åŠ¨<br/>åŸºäº host çš„å“ˆå¸Œå€¼]
    D --> E[æ·»åŠ éšæœºå™ªå£°<br/>Â±5% éšæœºæ‰°åŠ¨]
    E --> F[åŠ æƒéšæœºé€‰æ‹©èŠ‚ç‚¹]
    F --> G{èŠ‚ç‚¹é€‰æ‹©<br>æˆåŠŸï¼Ÿ}
    G -->|æ˜¯| H[åœ¨è¯¥èŠ‚ç‚¹åˆ›å»ºPinned Worker]
    G -->|å¦| I[æŠ›å‡ºå®¹é‡é”™è¯¯]
```

**ç®—æ³•å®ç°**ï¼š
```python
def node_select(self, nodes: List[NodeInfo], host: str) -> NodeInfo:
    available_nodes = [n for n in nodes if n.count < n.capacity]
    
    # 1. è®¡ç®—åŸºç¡€æƒé‡ï¼ˆå‰©ä½™å®¹é‡ï¼‰
    base_weights = [n.capacity - n.count for n in available_nodes]
    
    # 2. åŸºäº host çš„å“ˆå¸Œå€¼æ·»åŠ æ‰°åŠ¨
    host_hash = hash(host) % 1000 / 1000  # 0 <= host_hash < 1
    perturbed_weights = [
        w * (0.95 + 0.1 * ((host_hash + i / len(available_nodes)) % 1))
        for i, w in enumerate(base_weights)
    ]
    
    # 3. åŠ æƒéšæœºé€‰æ‹©
    return weighted_random_choice(available_nodes, perturbed_weights)
```

**æ‰¹é‡è°ƒåº¦å®ç°**ï¼š
```python
def batch_node_select(self, nodes: List[NodeInfo], hosts: List[str]):
    remaining = {n: n.capacity - n.count for n in nodes}
    
    for host in hosts:
        candidates = [n for n in nodes if remaining[n] > 0]
        
        # æƒé‡ = (å‰©ä½™å®¹é‡ + 1)^2ï¼Œåå‘ç©ºèŠ‚ç‚¹
        weights = [(remaining[n] + 1) ** 2 for n in candidates]
        
        # æ·»åŠ  Â±5% éšæœºå™ªå£°
        noisy_weights = [w * random.uniform(0.95, 1.05) for w in weights]
        
        # åŠ æƒéšæœºé€‰æ‹©
        selected = weighted_random_choice(candidates, noisy_weights)
        remaining[selected] -= 1
```

**ç‰¹ç‚¹**ï¼š
- âŒ **éç¡®å®šæ€§**ï¼šéšæœºæ€§æœ€å¼ºï¼Œç›¸åŒè¾“å…¥å‡ ä¹æ€»æ˜¯äº§ç”Ÿä¸åŒè¾“å‡º
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šæƒé‡åå‘å‰©ä½™å®¹é‡å¤§çš„èŠ‚ç‚¹ï¼Œè‡ªç„¶å®ç°è´Ÿè½½å‡è¡¡
- ğŸ¯ **æä½å†²çª**ï¼šéšæœºæ€§ + æƒé‡æ‰°åŠ¨ + å“ˆå¸Œæ‰°åŠ¨ï¼Œæœ€å¤§åŒ–é™ä½è°ƒåº¦å†²çª
- ğŸ“Š **å…¬å¹³æ€§**ï¼šå‰©ä½™å®¹é‡å¤§çš„èŠ‚ç‚¹è¢«é€‰ä¸­çš„æ¦‚ç‡æ›´é«˜
- âš¡ **å¤æ‚åº¦**ï¼šå•æ¬¡é€‰æ‹© O(N)ï¼Œæ‰¹é‡é€‰æ‹© O(M*N)ï¼ŒM ä¸ºä»»åŠ¡æ•°ï¼ŒN ä¸ºèŠ‚ç‚¹æ•°

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤§è§„æ¨¡å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆ5+ ä¸ªèŠ‚ç‚¹ï¼‰
- æé«˜å¹¶å‘åœºæ™¯ï¼ˆçŸ­æ—¶é—´å†…å¤§é‡ä»»åŠ¡ï¼‰
- è°ƒåº¦å†²çªä¸¥é‡çš„åœºæ™¯
- å¯ä»¥æ¥å—éç¡®å®šæ€§ç»“æœ

**æƒé‡è®¡ç®—ç­–ç•¥**ï¼š
- **åŸºç¡€æƒé‡**ï¼š`weight = capacity - count`ï¼ˆå‰©ä½™å®¹é‡ï¼‰
- **å¹³æ–¹åŠ æƒ**ï¼šæ‰¹é‡è°ƒåº¦æ—¶ä½¿ç”¨ `(remaining + 1)^2`ï¼Œæ›´åå‘ç©ºèŠ‚ç‚¹
- **å“ˆå¸Œæ‰°åŠ¨**ï¼šåŸºäº host çš„å“ˆå¸Œå€¼æ·»åŠ æ‰°åŠ¨ï¼Œç›¸åŒ host æ€»æ˜¯é€‰æ‹©ç›¸åŒèŠ‚ç‚¹ï¼ˆåœ¨å•æ¬¡è°ƒåº¦ä¸­ï¼‰
- **éšæœºå™ªå£°**ï¼šæ·»åŠ  Â±5% çš„éšæœºå™ªå£°ï¼Œæ‰“ç ´ä¸€è‡´æ€§ï¼Œé™ä½å†²çª

## é…ç½®ä¸ä½¿ç”¨

### é»˜è®¤ç®—æ³•

NetPulse çš„**é»˜è®¤è°ƒåº¦ç®—æ³•ä¸º `load_weighted_random`**ï¼Œè¯¥ç®—æ³•åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½èƒ½æä¾›è‰¯å¥½çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šèŠ‚ç‚¹ã€é«˜å¹¶å‘ç¯å¢ƒä¸­èƒ½å¤Ÿæœ‰æ•ˆé™ä½è°ƒåº¦å†²çªã€‚

### å¦‚ä½•ä¿®æ”¹è°ƒåº¦ç®—æ³•

è°ƒåº¦ç®—æ³•åœ¨ `config/config.yaml` æ–‡ä»¶ä¸­é…ç½®ï¼Œä¿®æ”¹ `worker.scheduler` å­—æ®µå³å¯ï¼š

```yaml
worker:
  scheduler: "load_weighted_random"  # ä¿®æ”¹ä¸ºå…¶ä»–ç®—æ³•ï¼šgreedy/least_load/least_load_random/load_weighted_random

plugin:
  scheduler: netpulse/plugins/schedulers/  # è°ƒåº¦å™¨æ’ä»¶ç›®å½•
```

**ä¿®æ”¹æ­¥éª¤**ï¼š

1. **ç¼–è¾‘é…ç½®æ–‡ä»¶**ï¼š
   ```bash
   vim config/config.yaml
   ```

2. **ä¿®æ”¹è°ƒåº¦å™¨é…ç½®**ï¼š
   ```yaml
   worker:
     scheduler: "least_load"  # æ”¹ä¸ºä½ éœ€è¦çš„ç®—æ³•
   ```

3. **é‡å¯æœåŠ¡**ï¼š
   ```bash
   # Docker Compose éƒ¨ç½²
   docker compose restart controller node-worker
   
   # æˆ–é‡æ–°éƒ¨ç½²
   docker compose down
   docker compose up -d
   ```

!!! warning "æ³¨æ„äº‹é¡¹"
    - ä¿®æ”¹è°ƒåº¦ç®—æ³•åéœ€è¦é‡å¯ Controller å’Œ Node Worker æ‰èƒ½ç”Ÿæ•ˆ
    - æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¸ä¼šå—åˆ°å½±å“ï¼Œæ–°ä»»åŠ¡ä¼šä½¿ç”¨æ–°çš„è°ƒåº¦ç®—æ³•
    - å»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œç®—æ³•åˆ‡æ¢ï¼Œé¿å…å½±å“æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡

### ä½•æ—¶éœ€è¦è°ƒæ•´è°ƒåº¦ç®—æ³•ï¼Ÿ

åœ¨ä»¥ä¸‹åœºæ™¯æˆ–é‡åˆ°ä»¥ä¸‹é—®é¢˜æ—¶ï¼Œå»ºè®®è°ƒæ•´è°ƒåº¦ç®—æ³•ï¼š

#### 1. å•èŠ‚ç‚¹éƒ¨ç½²åœºæ™¯
**é—®é¢˜**ï¼šå½“å‰ä½¿ç”¨é»˜è®¤çš„ `load_weighted_random`ï¼Œä½†åªæœ‰å•ä¸ªèŠ‚ç‚¹ï¼Œç®—æ³•å¤æ‚åº¦è¾ƒé«˜
**å»ºè®®**ï¼šåˆ‡æ¢åˆ° `greedy`
**åŸå› **ï¼šå•èŠ‚ç‚¹æ— éœ€è´Ÿè½½å‡è¡¡ï¼Œè´ªå©ªç®—æ³•ç®€å•é«˜æ•ˆ

#### 2. èŠ‚ç‚¹è´Ÿè½½ä¸¥é‡ä¸å‡
**é—®é¢˜**ï¼šè§‚å¯Ÿåˆ°æŸäº›èŠ‚ç‚¹è´Ÿè½½å¾ˆé«˜ï¼Œè€Œå…¶ä»–èŠ‚ç‚¹è´Ÿè½½å¾ˆä½
**å»ºè®®**ï¼šåˆ‡æ¢åˆ° `least_load` æˆ– `least_load_random`
**åŸå› **ï¼šè¿™äº›ç®—æ³•ä¼˜å…ˆé€‰æ‹©è´Ÿè½½æœ€å°çš„èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿå®ç°è´Ÿè½½å‡è¡¡

#### 3. è°ƒåº¦å†²çªé¢‘ç¹
**é—®é¢˜**ï¼šæ—¥å¿—ä¸­é¢‘ç¹å‡ºç° `HostAlreadyPinnedError` æˆ– `WorkerUnavailableError`
**å»ºè®®**ï¼šåˆ‡æ¢åˆ° `least_load_random` æˆ– `load_weighted_random`
**åŸå› **ï¼šéšæœºåŒ–ç®—æ³•èƒ½å¤Ÿé™ä½å¤šä¸ªè¯·æ±‚åŒæ—¶é€‰æ‹©åŒä¸€èŠ‚ç‚¹çš„æ¦‚ç‡

#### 4. éœ€è¦ç¡®å®šæ€§çš„è°ƒåº¦ç»“æœ
**é—®é¢˜**ï¼šéœ€è¦å¯é¢„æµ‹çš„è°ƒåº¦è¡Œä¸ºï¼Œç”¨äºè°ƒè¯•æˆ–æµ‹è¯•
**å»ºè®®**ï¼šåˆ‡æ¢åˆ° `greedy` æˆ– `least_load`
**åŸå› **ï¼šè¿™ä¸¤ä¸ªç®—æ³•æ˜¯ç¡®å®šæ€§çš„ï¼Œç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡º

#### 5. é«˜å¹¶å‘åœºæ™¯æ€§èƒ½ä¸‹é™
**é—®é¢˜**ï¼šåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»»åŠ¡æ‰§è¡Œå»¶è¿Ÿå¢åŠ ï¼Œååé‡ä¸‹é™
**å»ºè®®**ï¼šåˆ‡æ¢åˆ° `load_weighted_random`
**åŸå› **ï¼šè¯¥ç®—æ³•é€šè¿‡éšæœºåŒ–å’Œæƒé‡æ‰°åŠ¨æœ€å¤§åŒ–é™ä½è°ƒåº¦å†²çªï¼Œæå‡é«˜å¹¶å‘æ€§èƒ½

#### 6. æ‰¹é‡æ“ä½œæ•ˆç‡ä½
**é—®é¢˜**ï¼šæ‰¹é‡æ“ä½œæ—¶ï¼Œä»»åŠ¡åˆ†é…ä¸åˆç†ï¼Œæ‰§è¡Œæ—¶é—´è¿‡é•¿
**å»ºè®®**ï¼šæ ¹æ®èŠ‚ç‚¹æ•°é‡é€‰æ‹©ï¼š
- å•èŠ‚ç‚¹ï¼š`greedy`
- å¤šèŠ‚ç‚¹ï¼š`least_load` æˆ– `least_load_random`
**åŸå› **ï¼šä¸åŒç®—æ³•åœ¨æ‰¹é‡è°ƒåº¦æ—¶çš„ç­–ç•¥ä¸åŒï¼Œé€‰æ‹©åˆé€‚çš„ç®—æ³•å¯ä»¥æå‡æ‰¹é‡æ“ä½œæ•ˆç‡

### ç®—æ³•é€‰æ‹©å†³ç­–æ ‘

```
å¼€å§‹
  â”‚
  â”œâ”€ å•èŠ‚ç‚¹éƒ¨ç½²ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ greedy
  â”‚
  â”œâ”€ éœ€è¦ç¡®å®šæ€§ç»“æœï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ least_load
  â”‚
  â”œâ”€ è°ƒåº¦å†²çªé¢‘ç¹ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ load_weighted_randomï¼ˆé»˜è®¤ï¼‰
  â”‚
  â”œâ”€ èŠ‚ç‚¹è´Ÿè½½ä¸å‡ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ least_load æˆ– least_load_random
  â”‚
  â””â”€ å…¶ä»–åœºæ™¯ â†’ ä½¿ç”¨ load_weighted_randomï¼ˆé»˜è®¤ï¼‰
```

### è°ƒåº¦å†²çªè¯´æ˜

**ä»€ä¹ˆæ˜¯è°ƒåº¦å†²çªï¼Ÿ**

å½“å¤šä¸ª Controller åŒæ—¶ä¸ºä¸åŒè®¾å¤‡é€‰æ‹©èŠ‚ç‚¹æ—¶ï¼Œå¯èƒ½ä¼šé€‰æ‹©åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚ç”±äºèŠ‚ç‚¹å®¹é‡é™åˆ¶ï¼Œå…¶ä¸­ä¸€ä¸ªè¯·æ±‚ä¼šå¤±è´¥ï¼Œéœ€è¦é‡è¯•ã€‚è¿™å°±æ˜¯è°ƒåº¦å†²çªã€‚

**å†²çªçš„å½±å“**ï¼š
- å¯¼è‡´ä»»åŠ¡å¤±è´¥ï¼Œéœ€è¦é‡è¯•
- å¢åŠ ç³»ç»Ÿå»¶è¿Ÿ
- é™ä½ç³»ç»Ÿååé‡

**å¦‚ä½•é™ä½å†²çªï¼Ÿ**

1. **éšæœºåŒ–**ï¼š`least_load_random` å’Œ `load_weighted_random` é€šè¿‡éšæœºé€‰æ‹©é™ä½å†²çªæ¦‚ç‡
2. **æƒé‡æ‰°åŠ¨**ï¼š`load_weighted_random` ä½¿ç”¨å“ˆå¸Œå’Œéšæœºå™ªå£°è¿›ä¸€æ­¥é™ä½å†²çª
3. **æ‰¹é‡è°ƒåº¦**ï¼šæ‰¹é‡è°ƒåº¦æ—¶ï¼Œç®—æ³•ä¼šè€ƒè™‘æ•´ä½“è´Ÿè½½åˆ†å¸ƒï¼Œé¿å…é›†ä¸­åˆ†é…

**å†²çªæ¦‚ç‡å¯¹æ¯”**ï¼ˆå‡è®¾ 3 ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªå®¹é‡ 10ï¼Œå½“å‰è´Ÿè½½å‡ä¸º 5ï¼‰ï¼š
- `greedy`ï¼šé«˜ï¼ˆå¤šä¸ªè¯·æ±‚æ€»æ˜¯é€‰æ‹©ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
- `least_load`ï¼šä¸­ï¼ˆå¤šä¸ªè¯·æ±‚å¯èƒ½é€‰æ‹©åŒä¸€èŠ‚ç‚¹ï¼‰
- `least_load_random`ï¼šä½ï¼ˆéšæœºåŒ–åˆ†æ•£é€‰æ‹©ï¼‰
- `load_weighted_random`ï¼šæä½ï¼ˆéšæœºæ€§ + æƒé‡æ‰°åŠ¨ï¼‰

## å®ç°ç»†èŠ‚

### èŠ‚ç‚¹é€‰æ‹©æµç¨‹

æ‰€æœ‰è°ƒåº¦å™¨éƒ½å®ç° `node_select` æ–¹æ³•ï¼Œæ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š

```python
def node_select(self, nodes: List[NodeInfo], host: str) -> NodeInfo:
    # 1. è¿‡æ»¤å¯ç”¨èŠ‚ç‚¹ï¼ˆcount < capacityï¼‰
    available_nodes = [n for n in nodes if n.count < n.capacity]
    
    # 2. æ ¹æ®ç®—æ³•é€‰æ‹©èŠ‚ç‚¹
    selected_node = self._select_from_available(available_nodes, host)
    
    # 3. è¿”å›é€‰ä¸­çš„èŠ‚ç‚¹
    return selected_node
```

### è´Ÿè½½è®¡ç®—

èŠ‚ç‚¹çš„è´Ÿè½½é€šè¿‡ `NodeInfo.count` è¡¨ç¤ºï¼Œå³å½“å‰èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pinned Worker æ•°é‡ã€‚å®¹é‡é€šè¿‡ `NodeInfo.capacity` è¡¨ç¤ºï¼Œå³èŠ‚ç‚¹æœ€å¤§å¯è¿è¡Œçš„ Pinned Worker æ•°é‡ã€‚

### æ‰¹é‡è°ƒåº¦

æ‰€æœ‰è°ƒåº¦å™¨è¿˜å®ç°äº† `batch_node_select` æ–¹æ³•ï¼Œç”¨äºæ‰¹é‡é€‰æ‹©èŠ‚ç‚¹ï¼Œæé«˜è°ƒåº¦æ•ˆç‡ã€‚æ‰¹é‡è°ƒåº¦æ—¶ï¼Œç®—æ³•ä¼šè€ƒè™‘æ•´ä½“è´Ÿè½½åˆ†å¸ƒï¼Œé¿å…å°†æ‰€æœ‰ä»»åŠ¡åˆ†é…åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚
