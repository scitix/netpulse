#!/usr/bin/env python3
"""
公共工具模块（示例文件）

复制此文件为 common.py 并填入实际配置信息。
common.py 会被 git 忽略，不会提交到仓库。
"""

import time
from typing import Any, Dict, Optional

import requests

# ========== 配置区域 ==========
# 请根据实际情况修改以下配置

# NetPulse API 配置
BASE_URL = "http://localhost:9000"
API_KEY = "your-api-key-here"  # 替换为实际的 API Key

# 测试服务器配置
TEST_HOST = "192.168.1.100"  # 替换为实际的服务器地址
TEST_USERNAME = "admin"  # 替换为实际的用户名
TEST_PASSWORD = "your_password"  # 替换为实际的密码
TEST_PORT = 22

# 密钥文件配置(可选)
KEY_FILE = "~/.ssh/id_rsa"  # 私钥文件路径
KEY_PASSPHRASE = None  # 私钥密码(如果密钥有密码)

# sudo 密码(可选)
SUDO_PASSWORD = None  # sudo 密码(如果需要 sudo 权限)

# SSH 代理/跳板机配置(可选)
PROXY_HOST = "192.168.1.100"  # 代理服务器地址
PROXY_PORT = 22  # 代理服务器 SSH 端口
PROXY_USERNAME = None  # 代理服务器用户名(如果与目标服务器相同, 可以省略)
PROXY_PASSWORD = None  # 代理服务器密码(如果与目标服务器相同, 可以省略)

# =============================


class NetPulseClient:
    """NetPulse API 客户端工具类"""

    def __init__(self, base_url: str = "http://localhost:9000", api_key: str = ""):
        """
        初始化客户端

        Args:
            base_url: NetPulse API 基础 URL
            api_key: API 认证密钥
        """
        self.base_url = base_url.rstrip("/")
        self.api_key = api_key
        self.headers = {
            "X-API-KEY": api_key,
            "Content-Type": "application/json",
        }

    def request(self, method: str, endpoint: str, data: Optional[Dict] = None) -> Dict[str, Any]:
        """发送 HTTP 请求"""
        url = f"{self.base_url}{endpoint}"
        response = requests.request(method, url, headers=self.headers, json=data)
        response.raise_for_status()
        return response.json()

    def wait_for_job(self, job_id: str, timeout: int = 60) -> Dict[str, Any]:
        """等待任务完成并获取结果"""
        print(f"等待任务完成 (Job ID: {job_id})...")
        start_time = time.time()

        while time.time() - start_time < timeout:
            result = self.request("GET", f"/job?id={job_id}")
            # API 返回的 data 是列表, 取第一个元素
            job_data_list = result.get("data", [])
            if not job_data_list:
                raise Exception("未获取到任务数据")
            job_data = job_data_list[0]

            status = job_data.get("status", "unknown")
            print(f"任务状态: {status}")

            if status == "finished":
                return job_data
            elif status == "failed":
                error = job_data.get("result", {}).get("error", "Unknown error")
                raise Exception(f"任务执行失败: {error}")

            time.sleep(1)

        raise TimeoutError(f"任务超时 (>{timeout}秒)")

